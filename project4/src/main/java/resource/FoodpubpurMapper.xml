<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >	
	
<mapper namespace="project4.groupPurchase.Dao.FoodpubpurDao">
	<insert id="insertWrite" parameterType="fpp">
		INSERT INTO Foodpubpur VALUES(fpp_seq.nextval, 1, (SELECT userkey FROM users WHERE id = #{id}), 
		#{title}, to_char(sysdate,'YYYY-MM-DD'), #{content},#{loc}, #{meetcnt},#{paytype},0,0)
	</insert>
	
	<select id="getRead" parameterType="int" resultType="board">
		SELECT u.NICKNAME nickname, f.TITLE title, f.WRITEDATE writedate,
		f.CONTENT content , f.LOC loc , f.MEETCNT meetcnt, f.PAYTYPE paytype, b.BOARDNAME boardname 
		FROM FOODPUBPUR f , USERS u , BOARD b 
		WHERE f.USERKEY = u.USERKEY
		AND f.BOARDKEY = b.BOARDKEY
		AND f.FOODPUBPURKEY = #{fppkey}
	</select>
	
	<update id="uptViewcnt" parameterType="int">
		UPDATE Foodpubpur SET viewcnt = viewcnt+1
		WHERE FOODPUBPURKEY = #{fppkey}
	</update>

	<select id="getCommList" resultType="fcomm" parameterType="int">
		SELECT  rownum cnt,LEVEL,fc.FCOMMENTKEY fcommkey, fc.COMMCONTENTS commcontent ,fc.COMMDATE commdate , u.NICKNAME nickname
		FROM FOODPUBPUR f, FPPCOMM fc , USERS u 
		WHERE fc.fppkey = f.FOODPUBPURKEY
		AND fc.USERKEY = u.USERKEY 
		AND f.FOODPUBPURKEY = #{fppkey}
		START WITH refno=0
		CONNECT BY PRIOR fc.FCOMMENTKEY = fc.REFNO 
		ORDER siblings BY fc.FCOMMENTKEY DESC
	</select>
	
	<insert id="insertcomm" parameterType="insfcomm">
		INSERT INTO fppcomm VALUES ((SELECT NVL(MAX(FCOMMENTKEY)+1,1) FROM fppcomm),(SELECT userkey FROM users WHERE id = #{id}),#{commcontents},to_char(sysdate,'YYYY-MM-DD'),#{fppkey},0)
	</insert>
	
	<insert id="insertrecomm" parameterType="insfcomm">
		INSERT INTO fppcomm VALUES
		 ((SELECT NVL(MAX(FCOMMENTKEY)+1,1) FROM fppcomm),(SELECT userkey FROM users WHERE id = #{id}),
		 #{recommcontents},to_char(sysdate,'YYYY-MM-DD'),#{fppkey},#{refno})
	</insert>
	
	<delete id="delboard" parameterType="int">
		DELETE FROM FOODPUBPUR WHERE foodpubpurkey = #{foodpubpurkey}
	</delete>
	
	<select id="getfpp" resultType="fpp" parameterType="int">
		select *
		from FOODPUBPUR
		where FOODPUBPURKEY = #{foodpubpurkey}
	</select>
	
	<update id="uptboard" parameterType="fpp">
	UPDATE FOODPUBPUR SET 
	TITLE = #{title},
	WRITEDATE = to_char(sysdate,'YYYY-MM-DD') ,
	CONTENT = #{content} ,
	LOC = #{loc},
	MEETCNT = #{meetcnt},
	PAYTYPE = #{paytype}
	WHERE FOODPUBPURKEY = #{foodpubpurkey}
	</update>
	
	<select id="searchBdList" parameterType="string" resultType="boardList">
	SELECT f.FOODPUBPURKEY fppkey , f.TITLE title , f.LOC loc ,
		f.WRITEDATE writedate , u.NICKNAME nickname, f.viewcnt
	FROM FOODPUBPUR f , USERS u 
	WHERE f.USERKEY = u.USERKEY
	AND f.loc LIKE '%'||#{sch}||'%'
	order by fppkey desc
	</select>
	
	<select id="getBoardList" parameterType="boardList" resultType="boardList">
	SELECT*
	FROM (
		SELECT ROW_NUMBER() OVER (ORDER BY f.FOODPUBPURKEY desc ) AS cnt, f.FOODPUBPURKEY fppkey , f.TITLE title , f.LOC loc ,
		f.WRITEDATE writedate , u.NICKNAME nickname, f.viewcnt
		FROM FOODPUBPUR f , USERS u 
		WHERE f.USERKEY = u.USERKEY
		order by cnt asc )
	where cnt BETWEEN #{start} AND #{end}
	order by cnt
	</select>
	
	<insert id="insertFppFileInfo" parameterType="fppfileInfo">
		INSERT INTO FPPFILEINFO values(fpp_seq.currval, #{pathinfo},
			#{fname},sysdate,sysdate,#{etc})
	</insert>
	
	<select id="getFileInfo" parameterType="int" resultType="string">
		select fname from FPPFILEINFO where fno = #{fno}
	</select>
	
	<delete id="delcomm" parameterType="int">
		DELETE FROM FPPCOMM WHERE fcommentkey = #{fcommkey}
	</delete>
	
	<select id="totCnt" parameterType="boardList" resultType="int">
		select count(*)
		from FOODPUBPUR
		where 1=1
		<if test = "sch!=null and sch!=''">
		AND loc LIKE '%'||#{sch}||'%'
		</if>
	</select>
	
</mapper>